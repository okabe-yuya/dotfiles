---
name: impl-plan
description: |
  実装方針のプランを計画し、.plansディレクトリにMarkdownファイルとして出力する。
  「/impl-plan」「プランを立てて」「実装計画を作成」「設計を考えて」などの要求時に使用。
  Notion URLを渡すと、関連情報を取得して計画に反映する。
argument-hint: "[Notion URL (optional)] [タスク説明]"
user-invocable: true
allowed-tools: Read, Write, Glob, Grep, Bash(date *), Bash(mkdir *), Bash(ls *), Bash(test *)
---

# プランニングスキル

実装方針のプランを計画し、Markdownファイルとして出力するスキル。

## 実行フロー

### Step 1: 出力先ディレクトリの確認

まず `~/.claude/plans/` ディレクトリの存在を確認する。

```bash
test -d ~/.claude/plans
```

**ディレクトリが存在しない場合:**
- 以下の警告メッセージを出力して処理を中断する：

```
⚠️ エラー: プラン出力先ディレクトリが存在しません

plansディレクトリを作成してください：
  mkdir -p ~/.claude/plans

作成後、再度 /impl-plan を実行してください。
```

### Step 2: 入力の解析

引数を解析し、以下を判定：
- Notion URLの有無（`https://notion.so/` または `https://www.notion.so/` で始まるURL）
- タスク説明テキスト

### Step 3: Notion連携（URLがある場合）

Notion URLが渡された場合、`mcp__claude_ai_notion__notion-fetch` を使用してページ内容を取得する。

```
ToolSearch で "select:mcp__claude_ai_notion__notion-fetch" を実行してツールをロード
↓
mcp__claude_ai_notion__notion-fetch でページ内容を取得
```

**取得に失敗した場合:**
- 以下のメッセージを出力して処理を中断する：

```
⚠️ エラー: Notionページの取得に失敗しました

URL: {URL}
理由: {エラー内容}

URLが正しいか、アクセス権限があるか確認してください。
```

### Step 4: コードベースの調査

タスクに関連するコードベースを調査する：
- 関連ファイルの特定（Glob, Grep）
- 既存の実装パターンの確認（Read）
- 依存関係の把握

### Step 5: 質問と確認

プラン作成に必要な情報が不足している場合、ユーザーに質問する：
- 技術的な選択肢がある場合の優先度
- 要件の曖昧な部分の明確化
- 制約条件の確認

### Step 6: プラン作成

テンプレート（`~/.claude/skills/impl-plan/templates/plan-template.md`）に従ってプランを作成する。

### Step 7: ファイル出力

作成したプランを以下の形式でファイル出力：

**出力先:** `~/.claude/plans/`
**ファイル名:** `YYYYMMDD-HHMMSS-{日本語タイトル}.md`

```bash
# 現在日時の取得
date "+%Y%m%d-%H%M%S"
```

### Step 8: エージェントによるプラン精査

プランファイル出力後、以下の2つのエージェントを**同時にバックグラウンドで起動**する:

#### architect エージェント（技術観点）
- DDDの観点で集約の境界は適切か
- レイヤー構造（Controller → Application Service → Domain → Infrastructure）に問題はないか
- 影響範囲の記載漏れはないか

#### pm-reviewer エージェント（仕様観点）
- 要件の抜け漏れはないか（正常系・異常系・境界値・権限・状態遷移）
- 仕様に曖昧な記述はないか
- ユーザーシナリオの考慮不足はないか
- Phase間の依存関係に矛盾はないか

両エージェントへのプロンプトには、プランファイルの全文を含めること。

**ユーザーへの案内:**

```
プランファイルを出力しました: {ファイルパス}

バックグラウンドでプランを精査中です:
  - architect: 技術・アーキテクチャ観点
  - pm-reviewer: 仕様・ユーザーシナリオ観点

精査結果は数十秒後に返ります。その間にプランの内容をご確認ください。
```

### Step 9: 精査結果の報告

両エージェントの精査結果が返ったら、統合してユーザーに報告する。

**報告フォーマット:**

```
## プラン精査結果

### architect（技術観点）
{architect エージェントの指摘事項}

### pm-reviewer（仕様観点）
{pm-reviewer エージェントの指摘事項}

### 総合判定
- 実装開始可能 / 要修正
```

**指摘事項がある場合:**
- 指摘内容を一覧で提示する
- ユーザーの判断を仰ぎ、必要ならプランファイルを修正する

**指摘事項がない場合:**
- 問題なしの旨を報告し、`/impl-start` での実装開始を提案する

---

## イテレーション対応

プランに「確認事項」セクションがある場合、ユーザーが回答後に再度 `/impl-plan` を実行すると：

1. 既存のプランファイルを読み込む
2. 確認事項への回答を反映
3. プランを更新して同じファイルに上書き保存

---

## 注意事項

- プランは実装の指針であり、実際の実装は別途行う
- 確認事項は必ずチェックボックス形式（`- [ ]`）で記述する
- 技術的な判断が必要な箇所は明示的に選択肢を提示する
