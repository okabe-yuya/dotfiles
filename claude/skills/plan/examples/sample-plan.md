# ユーザー認証機能の実装

> 作成日時: 2026-02-06 14:30
> ステータス: Draft

## 概要

アプリケーションにJWTベースのユーザー認証機能を追加する。ログイン、ログアウト、セッション管理の基本機能を実装し、保護されたルートへのアクセス制御を可能にする。

## 背景・目的

### 背景
現在のアプリケーションは認証機能がなく、すべてのユーザーがすべての機能にアクセスできる状態。ユーザー固有のデータを扱う新機能の追加に伴い、認証機能が必要となった。

### 目的
- ユーザーの識別とセッション管理
- 保護されたリソースへのアクセス制御
- セキュアな認証フローの実現

### 関連情報
- 要件定義: https://notion.so/example/auth-requirements

## 技術的アプローチ

### 採用する方針
JWT（JSON Web Token）を使用したステートレス認証を採用する。アクセストークンとリフレッシュトークンの2トークン方式で、セキュリティと利便性のバランスを取る。

### 検討した代替案

| 方法 | メリット | デメリット | 採用理由 |
|------|----------|------------|----------|
| JWT認証 | ステートレス、スケーラブル | トークン無効化が複雑 | 採用：マイクロサービス対応を見据えて |
| セッション認証 | シンプル、即時無効化可能 | サーバー側でセッション管理必要 | 不採用：スケーラビリティの懸念 |
| OAuth2.0 | 外部プロバイダー連携可能 | 実装が複雑 | 将来的に検討 |

## 実装ステップ

### Phase 1: 認証基盤の構築
1. JWTライブラリの導入（jsonwebtoken）
2. 認証ミドルウェアの作成
3. トークン生成・検証ユーティリティの実装

### Phase 2: 認証エンドポイントの実装
1. `/api/auth/login` - ログイン処理
2. `/api/auth/logout` - ログアウト処理
3. `/api/auth/refresh` - トークンリフレッシュ

### Phase 3: フロントエンド対応
1. 認証状態管理（Context API）
2. ログインフォームコンポーネント
3. 保護されたルートのラッパーコンポーネント

## 影響範囲

### 変更対象ファイル
- `src/middleware/auth.ts` - 新規作成：認証ミドルウェア
- `src/routes/auth.ts` - 新規作成：認証エンドポイント
- `src/utils/jwt.ts` - 新規作成：JWT操作ユーティリティ
- `src/app.ts` - 変更：ミドルウェア追加
- `src/contexts/AuthContext.tsx` - 新規作成：認証状態管理

### 依存関係
- 既存のAPIエンドポイントに認証ミドルウェアを適用する必要あり
- データベースにユーザーテーブルが存在することが前提

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| トークン漏洩 | 高 | HTTPOnly Cookie使用、短い有効期限設定 |
| ブルートフォース攻撃 | 中 | レート制限の実装 |
| XSS攻撃 | 高 | CSP設定、入力サニタイズ |

## 検証方法

1. ログイン成功時にトークンが発行されることを確認
2. 無効なトークンでの保護されたルートへのアクセスが拒否されることを確認
3. トークンリフレッシュが正常に動作することを確認
4. ログアウト後にトークンが無効化されることを確認

---

## 確認事項

- [x] トークンの保存先 → HTTPOnly Cookie
- [ ] アクセストークンの有効期限は？（推奨: 15分〜1時間）
- [ ] リフレッシュトークンの有効期限は？（推奨: 7日〜30日）
- [ ] パスワードのハッシュアルゴリズムは？（bcrypt / argon2）
